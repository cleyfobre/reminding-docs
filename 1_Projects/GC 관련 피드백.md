#gc #kakaotalk #카톡

나: 안녕하세요. 회사 API서버 주기적으로 full gc해야하는 상황이라서 개선해야하는 상황인데.. 어디서부터 접근해야할지 몰라 질문 남겨봅니다 ㅠㅠ

Yoo y h:
FULL GC를 해야하는 이유가 무엇일까요
자바라면 프로그램 사실 .FULL GC를 강제적으로 해야할 이유가 없어서
오히려  STW 줄이려면 G1GC(JDK 7이상 JDK 11이하) 나 ZGC(JDK 높은 경우)  
을 해서 최대한 STW 서비스 정지를 피하는게 맞는데 ...
오히려 FULL GC를 해야한다라는 접근이 잘 못되신 것 같아요 ..

Lee t h:
이거는 반대로 수시로 GC가 안 일어나는 원인을 확인하셔야 할꺼같네요 누수까지는 아니더라도 객체 생존주기가 지나치게 길거나 공유가능한 중복된 내용에 객체가 많이 생성되거나 할꺼 같네요
보통 힙덤프 떠서 힙분석용 프로그램(무료임) 사용해서 조사하곤 합니다

나: Yoo y h님 Lee t h님 답변 감사합니다! 메모리를 높게 너무 오랫동안 점유하고 있어서 주기적으로 gc를 하고 있었습니다. 보통 배포하고나서 2~3주 지나면 한번씩 하고 있었어요. 말씀 주신거 참고해서 개선해보도록 할게요

Yoo y h: 
G1GC나 ZGC로 GC 옵션만 변경해도 큰 변화 있을거에요
드라마틱 변화 보장합니다
최소 성능상 15% 이상 차이나요
ZGC 바꾸면 35~40% 정도 차이나구요

나:
jdk11 쓰고 있습니다. 따로 설정한 것은 없는데 G1GC가 주기적으로 진행되고 있었다고 생각했었습니다. (jstat -gc {pid} 10000 써서 CGC 컬럼 보고 이런 생각을 했었습니다..) jdk를 올리진 못할 것 같고요 ㅎㅎㅎ
그리고 와탭 에이전트를 쓰고 있어서 그쪽 설정도 파악이 안된상태라.. 하나씩 봐보려고 합니다. 답변 너무 너무 감사합니다.

Yoo y h:
jstack {PID} > stack.dmp  뜬다음 Heap  Analyzer IBM 꺼나  다른 툴로 분석 참고해보세요~
아니면 와탭 APM 기능 중에  Database Connection Close 처리 안된거나 File Resource Handle 과정 중에서, flush close 미흡 처리 부분  Event 로그 쪽에 기록 해주는 옵션 켜시면 될거에요

+ -XX:ParallelGCThreads  CPU / 2  수치로 설정 해보시구요.
-XX:+UseStringDeduplication  (문자열 중복 제거 활성화)
-Xlog:gc*=debug => 모니터링용 JVM 옵션 추가 해서 
상세 모니터링 해보세욥
나머진 득안되는 옵션이라 당장 이정도 해볼 수 있겠네요