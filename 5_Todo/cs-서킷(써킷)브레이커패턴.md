# 서킷 브레이커 패턴

## 의미

- 어떤 모듈에 장애가 생겼을 때 더이상 호출하지 않고, 리스폰스를 대기하지 않고, 장애를 넓히지 않기 위해 이를 감지하고 대처하는 패턴
- 실패할 수 있는 요청을 하지 않도록 방지한다.

## 장점

- 장애 감지 및 격리
  - 만약 장애가 발생한 서비스를 호출한다면 요청이 타임아웃만큼 대기하게 되고, 쓰레드와 메모리 및 CPU 등의 자원을 점유하게 된다. 
  - 서킷 브레이커는 이러한 필요없는 호출을 안하게 해준다.
- 자동 시스템 복구
  - 서킷 브레이커는 요청이 차단되면 해당 서비스가 정상인지 주기적으로 검사한다. 그리고 해당 서비스가 복구되었다면 차단이 해제되고, 정상적으로 요청을 보내게 된다. 이러한 부분들은 시스템이 자동으로 해주므로 개발자들이 신경쓰지 않아도 된다. 
- 빠른 실패 및 고객 응답
  - 만약 다른 서비스가 문제있음을 알 수 있다면, 타임아웃 동안 기다리며 자원을 낭비할 필요가 없다.
- 장애 서비스로의 부하 감소
  - 외부 서비스가 완전히 죽지는 않았는데, slow query 등의 이유로 사용 가능한 쓰레드가 더 남아있지 않을 수도 있다. 이때 계속 요청을 보내는 것은 외부 서비스의 상황을 악화시켜 장애를 유발시킬 수 있다. 그러므로 해당 서비스가 안정을 찾도록 요청을 멈추는 것이 좋은데, 서킷 브레이커를 사용하면 해당 서비스는 더 이상의 요청이 유입되지 않아 장애를 복구할 수 있는 기회를 얻을 수 있다.
- 장애 대안 커스터마이징
  - 외부 서비스에서 장애가 발생했다면 원하는 데이터를 얻지 못할 수 있다. 이때 아무런 대응책이 없다면 해당 서비스 역시 장애가 발생하게 된다. 서킷 브레이커를 적용하면, 장애 대안을 커스터마이징 할 수 있는데, 예를 들어 다른 소스로부터 값을 얻어오거나, 서킷 브레이커가 자체적으로 캐싱해 둔 값으로 응답하는 등 다양한 방법을 적용할 수 있다. 그러면 외부에 장애가 발생해도 문제없이 서비스를 운영할 수도 있다.

## 라이브러리

- 자바 진영의 서킷 브레이커 라이브러리로는 크게 Hystrix와 Reslience4J가 존재한다. 
- Hystrix는 넷플릭스에서 만든 오픈소스인데, deprecated되었으므로 reslience4j를 사용하면 된다. 
- Hystrix에서도 오픈소스인 resilience4j 사용을 권장하고 있다.

## ref: https://mangkyu.tistory.com/261